# スプレッドシート掲示板アプリ

**これは学習者向けのサンプルプロジェクトです**

このプロジェクトは、Google Apps Script (GAS) をバックエンドとして使用し、GitHub Pages でホストされるフロントエンドを持つ掲示板アプリケーションです。コードは詳細なコメント付きで、Web開発とGoogle Apps Scriptの学習に最適です。

## 学習ポイント

このプロジェクトでは以下の技術と概念を学ぶことができます：

### バックエンド（Google Apps Script）

- **スプレッドシート操作**: シートの取得、作成、行の追加、データの読み書き
- **Web APIの作成**: `doGet`/`doPost` 関数を使用したHTTPリクエストの処理
- **CORS対応**: クロスオリジンリクエストの処理方法
- **JSONデータの取り扱い**: データのJSON形式での送受信

### フロントエンド（JavaScript/HTML/CSS）

- **Fetch API**: 非同期通信を使ったデータの取得と送信
- **DOM操作**: JavaScriptでのHTML要素の操作
- **イベント処理**: フォーム送信やボタンクリックなどのイベント処理
- **非同期処理**: async/awaitを使った非同期処理
- **エラーハンドリング**: try/catchを使ったエラー処理
- **セキュリティ対策**: HTMLエスケープによるXSS対策

### デプロイと運用

- **GAS Webアプリのデプロイ**: スクリプトをWeb APIとして公開する方法
- **GitHub Pages**: 静的サイトのホスティング方法

## 機能

- スプレッドシートに保存されたメッセージの表示
- 新しいメッセージの投稿（テキスト、ユーザー名、日時を保存）
- シンプルで使いやすいUI

## プロジェクト構成

```
GAS-Board/
├── index.html         # メインHTML（GitHubページ用にルートに配置）
├── css/               # スタイルシートディレクトリ
│   └── style.css      # メインCSS
├── js/                # JavaScriptディレクトリ
│   └── app.js         # メインアプリケーションロジック
└── backend/           # Google Apps Script (GAS) コード
    └── Code.gs        # GASのメインコード
```

## セットアップ手順

### バックエンド（Google Apps Script）のセットアップ

#### 方法１：共有スプレッドシートをコピーして使用する（推奨）

1. 以下の共有リンクからスプレッドシートを開きます（共有リンクをここに挿入）
2. 「ファイル > コピーを作成」を選択して、自分のGoogleドライブにコピーを作成します
3. コピーしたスプレッドシートを開き、「ツール > スクリプトエディタ」を選択します
4. スクリプトエディタには、既に必要なコードが設定されています
5. 「デプロイ > 新しいデプロイ」を選択します
6. 「種類の選択」で「ウェブアプリ」を選択します
7. 以下の設定を行います：
   - 説明：「掲示板アプリ」
   - ウェブアプリとして実行：「自分」
   - アクセスできるユーザー：「全員」
8. 「デプロイ」ボタンをクリックします
9. 表示されるウェブアプリのURLをコピーします（フロントエンドの設定で必要になります）

#### 方法２：新規にスプレッドシートを作成する

1. 新しいGoogleスプレッドシートを作成します
2. スプレッドシートの最初のシートを「Messages」という名前に変更します
3. 「Messages」シートに以下のヘッダーを追加します（A1:D1セル）：
   - `id` - メッセージID
   - `username` - ユーザー名
   - `message` - メッセージ内容
   - `timestamp` - 投稿日時
4. ツール > スクリプトエディタを選択してスクリプトエディタを開きます
5. `backend/Code.gs` の内容をスクリプトエディタにコピー＆ペーストします
6. 保存してから「デプロイ > 新しいデプロイ」を選択します
7. 以降の手順は方法１の手順６から９と同じです

### フロントエンド（GitHub Pages）のセットアップ

#### 方法１：公開されたGitHubリポジトリをクローンして使用する（推奨）

1. 以下のGitHubリポジトリをクローンします（リポジトリのURLをここに挿入）
   ```
   git clone ここにリポジトリのURLを挿入
   cd GAS-Board
   ```

2. `js/app.js` ファイルを開き、`GAS_API_URL` 変数を、バックエンドセットアップでコピーしたウェブアプリのURLに更新します

3. 以下のいずれかの方法でアプリを公開します：

   a) **ローカルでテストする場合**：
      - シンプルなHTTPサーバーを使用してローカルで実行できます（Pythonの場合）：
      ```
      python -m http.server 8000
      ```
      - ブラウザで http://localhost:8000 にアクセスします

   b) **GitHub Pagesで公開する場合**：
      - 自分のGitHubアカウントに新しいリポジトリを作成します
      - クローンしたファイルをアップロードします
      - リポジトリの設定から「GitHub Pages」を有効にします（mainブランチのルートディレクトリを選択）
      - GitHub Pagesが生成するURLにアクセスしてアプリケーションを使用します

#### 方法２：新規にフロントエンドを作成する

1. GitHubで新しいリポジトリを作成します
2. このプロジェクトのルートディレクトリにある以下のファイルとフォルダをリポジトリにアップロードします：
   - `index.html`
   - `css/` フォルダとその中の `style.css`
   - `js/` フォルダとその中の `app.js`
3. `js/app.js` ファイル内の `GAS_API_URL` 変数を、バックエンドセットアップでコピーしたウェブアプリのURLに更新します
4. リポジトリの設定から「GitHub Pages」を有効にします（mainブランチのルートディレクトリを選択）
5. GitHub Pagesが生成するURLにアクセスして、アプリケーションを使用します

## 使用方法

1. ページにアクセスすると、既存の投稿が表示されます
2. フォームにユーザー名とメッセージを入力して「投稿」ボタンをクリックすると、新しい投稿が追加されます
3. 投稿は自動的にGoogleスプレッドシートに保存され、ページに表示されます

## 注意事項

### Google Apps Script（GAS）の制限

- **実行時間の制限**: 1回の実行につき最大6分（トリガー付きの場合は30分）
- **スクリプトの容量制限**: プロジェクトあたり最大50MB
- **1日あたりのクォータ**:
  - メールの送信: 1日あたり最大100件
  - ドキュメントの作成: 1日あたり最大250件
  - スプレッドシートの作成: 1日あたり最大250件
  - ウェブアプリのリクエスト: 1日あたり最大20,000回
  - URLフェッチ: 1日あたり最大20,000回
- **同時実行の制限**: 同じユーザーによる同時実行は30件まで
- **レスポンスサイズの制限**: 最大10MB

### その他の注意点

- CORSの設定が正しく行われていることを確認してください
- 本番環境で使用する場合は、適切な認証とセキュリティ対策を実装してください
- 長時間実行される処理は、時間制限を考慮して分割することを検討してください

### Google Apps ScriptのCORS対応について

#### Content-Type: application/jsonを使用する際の問題

Google Apps Script (GAS) のウェブアプリでは、フロントエンドから`Content-Type: application/json`ヘッダーを使用してPOSTリクエストを送信すると、CORSエラーが発生することがあります。これは、GASのCORS処理がこのコンテンツタイプを適切に処理できないためです。

#### 対応方法

1. **フロントエンド側の対応**:
   - `Content-Type: application/x-www-form-urlencoded`を使用する
   - JSONデータの代わりに`URLSearchParams`を使用してデータを送信する

   ```javascript
   // 推奨される方法
   const formData = new URLSearchParams();
   formData.append('username', username);
   formData.append('message', message);
   
   fetch(GAS_API_URL, {
     method: 'POST',
     headers: {
       'Content-Type': 'application/x-www-form-urlencoded',
       'Accept': 'application/json'
     },
     body: formData
   })
   ```

2. **バックエンド側の対応**:
   - `e.postData.contents`からJSONをパースする代わりに、`e.parameter`からパラメータを直接取得する

   ```javascript
   function doPost(e) {
     // JSONパースではなく、直接パラメータにアクセス
     const username = e.parameter.username;
     const message = e.parameter.message;
     
     // 処理を続行...
   }
   ```

3. **OPTIONSリクエスト（プリフライト）の処理**:
   - ブラウザは複雑なリクエスト（カスタムヘッダーや特定のContent-Typeを含む）の前に、OPTIONSリクエストを送信します
   - GASでは、このOPTIONSリクエストに対して空のレスポンスを返すだけで十分な場合が多いです

   ```javascript
   function doPost(e) {
     if (e.method === 'OPTIONS') {
       return ContentService.createTextOutput('');
     }
     
     // 通常の処理を続行...
   }
   ```

これらの対応を行うことで、GASバックエンドとフロントエンド間のCORS関連のエラーを回避できます。

このプロジェクトを通じて、サーバーレスアプリケーションの開発手法と、無料ツールだけで実用的なウェブアプリを作成する方法を学ぶことができます。
